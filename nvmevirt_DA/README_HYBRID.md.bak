# NVMeVirt æ··åˆ SLC/QLC å­˜å‚¨å®žçŽ°

æœ¬é¡¹ç›®åŸºäºŽ [NVMeVirt](https://github.com/yuhun-Jun/nvmevirt_DA) å®žçŽ°äº†æ··åˆ SLC/QLC å­˜å‚¨æ¨¡æ‹Ÿå™¨ï¼Œæ”¯æŒçƒ­æ•°æ®è·Ÿè¸ªã€è‡ªåŠ¨è¿ç§»å’Œä¸åŒå»¶è¿Ÿæ¨¡æ‹Ÿã€‚

## ðŸš€ ä¸»è¦ç‰¹æ€§

### âœ¨ æ··åˆå­˜å‚¨æž¶æž„
- **SLC ç¼“å­˜å±‚**ï¼š20% å®¹é‡ï¼Œé«˜æ€§èƒ½å†™å…¥
- **QLC å­˜å‚¨å±‚**ï¼š80% å®¹é‡ï¼Œå¤§å®¹é‡å­˜å‚¨
- **æ™ºèƒ½è¿ç§»**ï¼šè‡ªåŠ¨å°†å†·æ•°æ®ä»Ž SLC è¿ç§»åˆ° QLC

### ðŸ”¥ çƒ­æ•°æ®ç®¡ç†
- **è®¿é—®è·Ÿè¸ª**ï¼šè®°å½•æ¯ä¸ªé¡µé¢çš„è®¿é—®æ¬¡æ•°å’Œæ—¶é—´
- **è¿ç§»ç­–ç•¥**ï¼šåŸºäºŽè®¿é—®æ¨¡å¼çš„æ™ºèƒ½è¿ç§»ç®—æ³•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šçƒ­æ•°æ®ä¿æŒåœ¨é«˜é€Ÿ SLC ä¸­

### âš¡ æ€§èƒ½å·®å¼‚åŒ–
- **SLC å»¶è¿Ÿ**ï¼šåŽŸæœ‰çš„é«˜æ€§èƒ½å‚æ•°
- **QLC å»¶è¿Ÿ**ï¼šè¯»å»¶è¿Ÿ 2.5-3 å€ï¼Œå†™å»¶è¿Ÿ 4 å€ï¼Œæ“¦é™¤å»¶è¿Ÿ 3 å€
- **çœŸå®žæ¨¡æ‹Ÿ**ï¼šåŸºäºŽå®žé™…ç¡¬ä»¶ç‰¹æ€§çš„å»¶è¿Ÿå»ºæ¨¡

## ðŸ“ æ–‡ä»¶ä¿®æ”¹æ¦‚è§ˆ

### æ ¸å¿ƒä¿®æ”¹æ–‡ä»¶
```
â”œâ”€â”€ ssd_config.h          # æ·»åŠ  QLC å»¶è¿Ÿå‚æ•°å®šä¹‰
â”œâ”€â”€ ssd.h                 # æ‰©å±•å»¶è¿Ÿå‚æ•°ç»“æž„
â”œâ”€â”€ ssd.c                 # å®žçŽ° SLC/QLC å»¶è¿Ÿå·®å¼‚åŒ–
â”œâ”€â”€ conv_ftl.h            # æ·»åŠ æ··åˆå­˜å‚¨æ•°æ®ç»“æž„
â””â”€â”€ conv_ftl.c            # å®žçŽ°æ ¸å¿ƒæ··åˆå­˜å‚¨é€»è¾‘
```

### æ–°å¢žæ–‡ä»¶
```
â”œâ”€â”€ HYBRID_SSD_CONFIG.md  # è¯¦ç»†é…ç½®è¯´æ˜Ž
â”œâ”€â”€ README_HYBRID.md      # æœ¬æ–‡æ¡£
â”œâ”€â”€ test_hybrid_ssd.sh    # è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â””â”€â”€ quick_fix.sh          # å¿«é€Ÿä¿®å¤è„šæœ¬
```

## ðŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ä¸€é”®ä¿®å¤å’Œç¼–è¯‘
```bash
./quick_fix.sh
```

### 2. æ‰‹åŠ¨ç¼–è¯‘ï¼ˆå¦‚æžœéœ€è¦ï¼‰
```bash
make clean
make APPROACH=on
```

### 3. è¿è¡Œæµ‹è¯•
```bash
sudo ./test_hybrid_ssd.sh
```

## ðŸ“Š å…³é”®é…ç½®å‚æ•°

### å®¹é‡åˆ†é…ï¼ˆssd_config.hï¼‰
```c
#define SLC_CAPACITY_PERCENT (20)  // SLC 20%
#define QLC_CAPACITY_PERCENT (80)  // QLC 80%
#define QLC_REGIONS (4)            // QLC 4 ä¸ªåŒºåŸŸ
```

### å»¶è¿Ÿå‚æ•°ï¼ˆssd_config.hï¼‰
```c
#define QLC_PROG_LATENCY (185000 * 4)      // QLC å†™å»¶è¿Ÿæ˜¯ SLC çš„ 4 å€
#define QLC_ERASE_LATENCY (3000000)        // QLC æ“¦é™¤å»¶è¿Ÿæ˜¯ SLC çš„ 3 å€
#define MIGRATION_THRESHOLD (10)           // è¿ç§»è®¿é—®æ¬¡æ•°é˜ˆå€¼
```

## ðŸ”§ å·¥ä½œåŽŸç†

### å†™å…¥æµç¨‹
1. **åˆæ¬¡å†™å…¥** â†’ SLCï¼ˆä½¿ç”¨ Die Affinityï¼‰
2. **çƒ­æ•°æ®è·Ÿè¸ª** â†’ è®°å½•è®¿é—®æ¨¡å¼
3. **åŽå°è¿ç§»** â†’ å†·æ•°æ®è¿ç§»åˆ° QLC
4. **åŒºåŸŸè½®è¯¢** â†’ QLC 4 åŒºåŸŸå‡è¡¡å†™å…¥

### è¯»å–æµç¨‹
1. **ä½ç½®æ£€æµ‹** â†’ åˆ¤æ–­æ•°æ®åœ¨ SLC è¿˜æ˜¯ QLC
2. **å»¶è¿Ÿå·®å¼‚** â†’ ä½¿ç”¨å¯¹åº”çš„å»¶è¿Ÿå‚æ•°
3. **çƒ­åº¦æ›´æ–°** â†’ æ›´æ–°è®¿é—®è®¡æ•°å’Œæ—¶é—´

### è¿ç§»è§¦å‘æ¡ä»¶
- é•¿æ—¶é—´æœªè®¿é—®ï¼ˆ>1ç§’ï¼‰
- è®¿é—®æ¬¡æ•°ä½ŽäºŽé˜ˆå€¼ï¼ˆ<10æ¬¡ï¼‰
- SLC ç©ºé—´ä¸è¶³æ—¶ä¼˜å…ˆè¿ç§»

## ðŸ“ˆ æ€§èƒ½é¢„æœŸ

| æ“ä½œç±»åž‹ | SLC æ€§èƒ½ | QLC æ€§èƒ½ | æ€§èƒ½æ¯” |
|---------|----------|----------|--------|
| 4KB è¯»å– | ~30Î¼s    | ~75Î¼s    | 2.5x   |
| é¡µé¢è¯»å– | ~36Î¼s    | ~108Î¼s   | 3x     |
| é¡µé¢å†™å…¥ | ~185Î¼s   | ~740Î¼s   | 4x     |
| å—æ“¦é™¤   | 1ms      | 3ms      | 3x     |

## ðŸ§ª æµ‹è¯•åœºæ™¯

### è‡ªåŠ¨åŒ–æµ‹è¯•åŒ…å«
1. **é¡ºåºå†™å…¥æµ‹è¯•** - éªŒè¯ SLC å†™å…¥æ€§èƒ½
2. **éšæœºå†™å…¥æµ‹è¯•** - éªŒè¯ Die Affinity å·¥ä½œ
3. **è¯»å–æµ‹è¯•** - éªŒè¯å»¶è¿Ÿå·®å¼‚åŒ–
4. **æ··åˆè¯»å†™æµ‹è¯•** - è§¦å‘è¿ç§»æœºåˆ¶

### ç›‘æŽ§æŒ‡æ ‡
```bash
# æŸ¥çœ‹å®žæ—¶ç»Ÿè®¡
dmesg | grep -E "(SLC|QLC|Migration|Write Stats)"

# é¢„æœŸè¾“å‡ºç¤ºä¾‹
[nvmev] SLC blocks per plane: 1638 (20%), QLC blocks per plane: 6554 (80%)
[nvmev] Write Stats: SLC writes=10000, QLC writes=0, Migrations=150
[nvmev] Migrated LPN 12345 from SLC to QLC region 2
```

## ðŸŽ›ï¸ è°ƒä¼˜å»ºè®®

### æé«˜ SLC æ¯”ä¾‹ï¼ˆé€‚åˆå†™å…¥å¯†é›†åž‹ï¼‰
```c
#define SLC_CAPACITY_PERCENT (30)
#define QLC_CAPACITY_PERCENT (70)
```

### è°ƒæ•´è¿ç§»ç­–ç•¥ï¼ˆé€‚åˆä¸åŒå·¥ä½œè´Ÿè½½ï¼‰
```c
#define MIGRATION_THRESHOLD (20)   // æé«˜é˜ˆå€¼ï¼Œå‡å°‘è¿ç§»
```

### å¢žåŠ  QLC åŒºåŸŸæ•°ï¼ˆæé«˜å¹¶å‘æ€§ï¼‰
```c
#define QLC_REGIONS (8)            // æ›´å¤šåŒºåŸŸï¼Œæ›´å¥½çš„å¹¶å‘
```

## ðŸ› æ•…éšœæŽ’é™¤

### ç¼–è¯‘é—®é¢˜
```bash
# å®‰è£…å†…æ ¸å¤´æ–‡ä»¶
sudo apt install linux-headers-$(uname -r)

# æ¸…ç†é‡æ–°ç¼–è¯‘
make clean && make APPROACH=on
```

### è¿è¡Œæ—¶é—®é¢˜
```bash
# æ£€æŸ¥å†…å­˜é¢„ç•™
cat /proc/meminfo | grep Hugepages

# æ£€æŸ¥æ¨¡å—çŠ¶æ€
lsmod | grep nvmev

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
dmesg | tail -50
```

### æ€§èƒ½é—®é¢˜
- ç¡®è®¤ DIEAFFINITY=1 å·²å¯ç”¨
- æ£€æŸ¥ CPU ç»‘å®šæ˜¯å¦æ­£ç¡®
- ç›‘æŽ§è¿ç§»é¢‘çŽ‡æ˜¯å¦åˆç†

## ðŸ“š å‚è€ƒèµ„æ–™

- [åŽŸå§‹ NVMeVirt é¡¹ç›®](https://github.com/yuhun-Jun/nvmevirt_DA)
- [FAST '24 è®ºæ–‡](https://github.com/yuhun-Jun/fast24_ae)
- [é…ç½®è¯¦ç»†è¯´æ˜Ž](HYBRID_SSD_CONFIG.md)

## ðŸ¤ è´¡çŒ®å’Œæ”¯æŒ

å¦‚æžœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [HYBRID_SSD_CONFIG.md](HYBRID_SSD_CONFIG.md) èŽ·å–è¯¦ç»†é…ç½®è¯´æ˜Ž
2. è¿è¡Œ `./quick_fix.sh` å°è¯•è‡ªåŠ¨ä¿®å¤
3. æ£€æŸ¥ dmesg æ—¥å¿—èŽ·å–æ›´å¤šä¿¡æ¯

---

**æ³¨æ„**ï¼šæ­¤å®žçŽ°ä¸»è¦ç”¨äºŽç ”ç©¶å’Œæ•™å­¦ç›®çš„ï¼Œåœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†æµ‹è¯•ã€‚ 